name: Deploy-IAC

trigger:
  branches:
    include:
      - dev
  paths:
    exclude:
      - '*'

pr:
  branches:
    include:
      - dev

variables:
  - ${{ if eq(variables['Build.SourceBranch'], 'refs/heads/dev') }}: 
    - template: ./configdev.yml
  - ${{ if eq(variables['Build.SourceBranch'], 'refs/heads/main') }}: 
    - template: ./configprd.yml


pool:
  name: jensazureagentpool
  

stages:
- stage: UpdateVM
  displayName: Bootstrap tools on agent VM
  jobs:
  - job: UpdateVMJob
    displayName: Update VMSS Job
    steps:
    - task: AzureCLI@2
      displayName: Bootstrap tools on agent VM
      inputs:
        azureSubscription: 'ado-sc'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
              set -euxo pipefail

              # DO NOT reinstall Azure CLI inside AzureCLI@2; az is already present.

              # Install Bicep and make it globally available for later tasks
              az bicep install
              BICEP_SRC="${AZURE_CONFIG_DIR:-$HOME/.azure}/bin/bicep"
              sudo install -m 0755 "$BICEP_SRC" /usr/local/bin/bicep
              /usr/local/bin/bicep --version

              # Base utils (quiet, noninteractive)
              sudo DEBIAN_FRONTEND=noninteractive apt-get -yq update
              sudo DEBIAN_FRONTEND=noninteractive apt-get -yq install unzip ca-certificates curl lsb-release gnupg

              # Databricks CLI â€” skip if already installed
              if command -v databricks >/dev/null 2>&1; then
                echo "Databricks CLI present at $(command -v databricks); skipping reinstall."
              else
                curl -fsSL --connect-timeout 10 --retry 3 https://raw.githubusercontent.com/databricks/setup-cli/main/install.sh | sudo sh
              fi
              databricks --version || true

              # VS Code via snap (best-effort)
              if command -v snap >/dev/null 2>&1; then
                sudo snap install --classic code || true
              fi
            - task: AzureCLI@2
              displayName: Install Bicep
              inputs:
                azureSubscription: 'ado-sc'
                scriptType: bash
                scriptLocation: inlineScript
                inlineScript: |
                  set -euxo pipefail
                  az bicep install
                  az bicep build --file ./iac-adb-360/main.bicep



# --- Azure ops (use your service connection) ---
- stage: AzureCLI2
  displayName: Ensure RG + enable per-instance Public IPs on VMSS
  jobs:
  - job: AzureCLIJob
    displayName: Azure CLI Job
    steps:
    - task: AzureCLI@2
      inputs:  
        azureSubscription: 'ado-sc'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          # Add a public IP configuration to the NIC
          az vmss update \
            -g 'vmssagents' -n 'vmssagentspool' \
            --set virtualMachineProfile.networkProfile.networkInterfaceConfigurations[0].ipConfigurations[0].publicIPAddressConfiguration='{"name":"pubip","idleTimeoutInMinutes":10}'

          # Apply change to existing instances
          az vmss update-instances -g 'vmssagents' -n 'vmssagentspool' --instance-ids "*"

          # List connection info (public IPs, ports, etc.)
          az vmss list-instance-connection-info -g 'vmssagents' -n 'vmssagentspool' -o table

- stage: checkbicep
  displayName: check bicep
  jobs:
    - job: checkbicepjob
      displayName: check bicep syntax
      steps:
        - script: |
            echo "Checking bicep syntax..."
            bicep build ./iac-adb-360/main.bicep
          displayName: checking bicep syntax ...

- stage: validatebicep
  displayName: Validate Bicep against Azure
  jobs:
    - job: ValidateBicepJob
      displayName: Validate Bicep Job
      steps:
      - task: AzureCLI@2
        inputs:
          azureSubscription: 'ado-sc'
          scriptType: 'bash'
          scriptLocation: 'inlineScript'
          inlineScript: 'az deployment group validate --resource-group $(resourcegroup) --template-file ./iac-adb-360/main.bicep --parameters baseName=$(baseName) env=$(env)'


- stage: Deploy
  displayName: Deploy Stage
  jobs:
    - deployment: DeployJob
      displayName: Deploy to dev environment
      environment: dev
      strategy:
        runOnce:
          deploy:
            steps:
              - checkout: self
              - task: AzureCLI@2
                inputs:
                  azureSubscription: 'ado-sc'
                  scriptType: 'bash'
                  scriptLocation: 'inlineScript'
                  inlineScript: 'az deployment group create --resource-group $(resourcegroup) --template-file ./iac-adb-360/main.bicep --parameters baseName=$(baseName) env=$(env)'
  

name: PostMetastoreDeploy

trigger:
  branches:
    include:
      - devy        # <-- was "devy"
  paths:
    include:
      - '*'

variables:
  - ${{ if or(eq(variables['Build.SourceBranchName'], 'dev'), eq(variables['System.PullRequest.TargetBranchName'], 'dev')) }}:
    - group: vgdevadb360
  - ${{ else }}:
    - group: vgprdadb360

stages:
# ----------------- assign workspace to metastore -----------------
- stage: s_assignmetastore
  displayName: 'assign workspace to metastore'
  jobs:
  - job: j_assignmetastore
    displayName: 'job assign workspace to metastore'
    pool:
      name: jensazureagentpool
    steps:
    - checkout: self

    - task: CmdLine@2
      displayName: 'Prereqs (unzip)'
      inputs:
        script: |
          set -eux
          if command -v apt-get >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y unzip
          elif command -v yum >/dev/null 2>&1; then
            sudo yum install -y unzip
          elif command -v zypper >/dev/null 2>&1; then
            sudo zypper install -y unzip
          else
            echo "No supported pkg manager found"; exit 1
          fi

    # - task: CmdLine@2
    #   displayName: 'Install Databricks CLI v2 (sudo)'
    #   inputs:
    #     script: |
    #       set -euxo pipefail
    #       curl -fsSL https://raw.githubusercontent.com/databricks/setup-cli/main/install.sh | sudo bash
    #       echo "##vso[task.prependpath]/usr/local/bin"
    #       databricks version

    - task: AzureCLI@2
      displayName: 'Call script assign workspace to metastore'
      inputs:
        azureSubscription: 'ado-sc'
        scriptType: 'bash'
        scriptLocation: 'scriptPath'
        scriptPath: './iac-adb-360/helpers/attach-workspace-to-metastore.sh'
        arguments: '$(resourceGroupName) $(tenantId) $(clientId) $(clientSecret) $(metastorename)'

# ----------------- assign repository to spn -----------------
- stage: s_assignrepo
  displayName: 'assign repository to spn'
  jobs:
  - job: j_assignrepo
    displayName: 'job assign repository to spn'
    pool:
      name: jensazureagentpool
    steps:
    - checkout: self

    # - task: CmdLine@2
    #   displayName: 'Prereqs (unzip)'
    #   inputs:
    #     script: |
    #       set -eux
    #       if command -v apt-get >/dev/null 2>&1; then
    #         sudo apt-get update
    #         sudo apt-get install -y unzip
    #       elif command -v yum >/dev/null 2>&1; then
    #         sudo yum install -y unzip
    #       elif command -v zypper >/dev/null 2>&1; then
    #         sudo zypper install -y unzip
    #       else
    #         echo "No supported pkg manager found"; exit 1
    #       fi
    # - task: CmdLine@2
    #   displayName: 'Install Databricks CLI v2 (sudo)'
    #   inputs:
    #     script: |
    #       set -euxo pipefail
    #       curl -fsSL https://raw.githubusercontent.com/databricks/setup-cli/main/install.sh | sudo bash
    #       echo "##vso[task.prependpath]/usr/local/bin"
    #       databricks version

    - task: AzureCLI@2
      displayName: 'Call script: attach to repo (GitHub)'
      inputs:
        azureSubscription: 'ado-sc'
        scriptType: bash
        scriptLocation: scriptPath
        scriptPath: './iac-adb-360/helpers/attach-to-repo-github.sh'
        arguments: '$(resourceGroupName) $(tenantId) $(clientId) $(clientSecret) $(repourl) $(ghuser) $(ghpat)'

# - stage: s_createcluster
#   displayName: 'create the cluster'
#   jobs:
#   - job: j_createcluster
#     displayName: 'Job creating the cluster'
#     pool:
#       name: 'ubuntu-latest'
#     steps:
#     - task: CmdLine@2
#       inputs:
#         script: |
#           curl -fsSL https://raw.githubusercontent.com/databricks/setup-cli/main/install.sh | sh
#       displayName: 'Install Databricks CLI v 2'
#     - task: AzureCLI@2
#       displayName: 'Call script to create a cluster'
#       inputs:
#         azureSubscription: 'adb-sc'
#         scriptType: 'bash'
#         scriptLocation: 'scriptPath'
#         scriptPath: './iac-adb-360/helpers/create-cluster.sh'
#         arguments: '$(resourceGroupName) $(tenantId) $(clientId) $(clientSecret) $(clusterconf)'
